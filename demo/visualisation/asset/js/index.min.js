var mapData;var topoData;var lineData1;var lineData2;var barData1;var barData2;var dotsData;var erData;var currentYear;var currentArea;var playTimer;var playInterval;var priceRange=[50000,100000,150000,200000,250000,300000,350000,400000,450000];var colorScheme=colorbrewer.RdYlBu["11"].reverse();var dotsColor=["red","blue","yellow","green","orange","black","cyan","blueviolet","lightpink","dimgray","peru"];$(function(){showLoading();initScroll();loadData(function(){initMap();initLine();initBar();initBarBar();initDots();initDotsLine()})});function loadData(a){d3.queue().defer(d3.json,"./asset/data/lad-simple.json").defer(d3.csv,"./asset/data/5a.csv").defer(d3.csv,"./asset/data/1a.csv").defer(d3.csv,"./asset/data/1b.csv").defer(d3.csv,"./asset/data/1c.csv").defer(d3.csv,"./asset/data/5c.csv").defer(d3.csv,"./asset/data/dots.csv").defer(d3.csv,"./asset/data/er.csv").await(function(f,c,g,l,k,h,e,j,d){mapData=g;topoData=c;var b=_.map(mapData,function(m){return m["Local authority code"]});topoData.objects.lad.geometries=_.filter(topoData.objects.lad.geometries,function(n){var m=n.properties.lad16cd;return m.charAt(0)!=="S"&&_.contains(b,m)});function i(o,n,p){var m={};_.each(_.filter(o,function(q){return q[n]!==""}),function(r){var u=[];for(var q=1997;q<2017;q++){var t=r["Q3-"+q]||r[q];t=parseFloat(t.replace(/,/g,""));var s={area:r[n],year:q,date:new Date(q,0,1)};s[p]=t;u.push(s)}m[r[n]]=u});return m}lineData1=i(l,"Name","price");lineData2=i(k,"Name","price");barData1=i(h,"Name","ratio");barData2=e;dotsData=j;erData=i(d,"Region name","rate");a();hideLoading()})}function initScroll(){var e=100*2;var a=$(window).height();var b=a-e;var d=$(".page");var c=0;d.each(function(f,h){var g=$(h).height();g=Math.max(b,g);$(h).css({height:g+"px",top:c+"px",zIndex:f}).data("top",c).data("height",g+e);c+=g+e});$(window).on("scroll",function(){var f=$(window).scrollTop();d.each(function(l,n){var m=$(n);var p=parseInt(m.data("top"),10);var k=f-p;var q=parseInt(m.data("height"),10);var g=0;var j=1;var o="0deg";var h=0;if(k>q-a){k=k-q+a;k=k/2;g=k;j=1-k/(q*5);o=(j-1)*15+"deg";h=400}m.css({transform:"scale("+j+") perspective("+h+"px) rotateX("+o+") translate3d(0, "+g+"px, 0)"})})})}function initMap(){var d=document.getElementById("map").clientWidth;var b=document.getElementById("map").clientHeight;var c=d3.select("#map").append("svg").attr("width",d).attr("height",b);var f=c.append("g");var e=initZoom(c,f,d,b);c.call(e);var a=d3.geoAlbers().rotate([0,0]);var h=d3.geoPath().projection(a);drawMap({svg:c,g:f,zoom:e,projection:a,path:h,width:d,height:b,topo:topoData,data:mapData});initPlayer()}function drawMap(d){var x=d.projection;var o=d.path;var h=d.topo;var p=d.width;var l=d.height;var m=d.svg;var u=d.g;var a=d.zoom;var y=d.data;var v,k;var f=[];_.each(y,function(b){_.mapObject(b,function(t,g){if(g.indexOf("Q3-")===0){var s=parseInt(t.replace(/,/g,""),10);if(!v||s>v){v=s}if(!k||s<k){k=s}f.push(s)}})});f.sort();priceRange.unshift(k-100);priceRange.push(v+100);x.scale(1).translate([0,0]);var w=o.bounds(topojson.feature(h,h.objects.lad));var j=0.95/Math.max((w[1][0]-w[0][0])/p,(w[1][1]-w[0][1])/l);var i=[(p-j*(w[1][0]+w[0][0]))/2,(l-j*(w[1][1]+w[0][1]))/2];x.scale(j).translate(i);var c=u.selectAll(".area").data(topojson.feature(h,h.objects.lad).features);c.enter().append("path").attr("class","area").attr("stroke","#666").attr("stroke-opacity",0.3).attr("stroke-width",0.7).attr("fill","#ffffff").attr("id",function(b){return b.properties.lad16cd}).attr("d",o).on("click",q);initSelectYear();r();var e=d3.selectAll(null);function q(z){if(e.node()===this){n();return}e.style("fill-opacity",1);e.style("stroke-opacity",0.3);e.attr("stroke","#666");e.style("stroke-width",0.7);e=d3.select(this);e.style("fill-opacity",0.3);e.style("stroke-opacity",1);e.attr("stroke","#000");e.style("stroke-width",1.5);for(var s=0;s<mapData.length;s++){var g=mapData[s];if(g["Local authority code"]===z.properties.lad16cd){currentArea=z.properties.lad16cd;var t=g["Q3-"+currentYear];var b=g["Local authority name"];setSelectedInfo(b,t)}}}function n(){currentArea=null;$(".local-authority").html("");$(".price").html("");e.style("fill-opacity",1);e.style("stroke-opacity",0.3);e.style("stroke","#666");e.style("stroke-width",0.7);e=d3.select(null)}function r(){var z=10;var t=10;var s=m.append("g").attr("transform","translate("+z+","+t+")");s.append("text").attr("x",z).attr("y",t+16).attr("font-weight","bold").text("Median house price");s.append("text").attr("x",z).attr("y",t+36).attr("font-weight","bold").text("£");for(var b=0;b<10;b++){s.append("rect").attr("width",20).attr("height",20).attr("x",z).attr("y",t+b*20+40).attr("fill",colorScheme[b]);var A=csn(priceRange[b])+"~"+csn(priceRange[b+1]);if(b===0){A="<"+csn(priceRange[1])}else{if(b===9){A=">"+csn(priceRange[9])}}s.append("text").attr("x",z+30).attr("y",t+(b+1)*20+40-4).attr("font-size",12).text(A)}}}function initZoom(b,h,e,a){var f=d3.zoom().scaleExtent([1,10]).on("zoom",i);var c=d3.zoomTransform(f);function i(){if(d3.event.sourceEvent){c=d3.event.transform}h.attr("transform",c)}function d(){var j=c.k;var k=(this.id==="zoom_in")?1:-1;var l=k*0.2;if(c.k+l<1){c.k=1;l=1-j}else{if(c.k+l>10){c.k=10;l=10-j}else{c.k+=l}}var g=e/2;var m=a/2;c.x-=l*g;c.y-=l*m;b.transition().duration(500).call(f.transform,d3.zoomIdentity.translate(c.x,c.y).scale(c.k))}d3.selectAll(".zoom").on("click",d);return f}function initPlayer(){$("#play").on("click",function(){var a=$(this);if(a.hasClass("pause")){a.removeClass("pause").addClass("play");clearInterval(playTimer)}else{a.removeClass("play").addClass("pause");playByYear(currentYear+1)}})}function playByYear(b){var c=b||2016;if(c>2016){c=1997}var d=$("#selectYear")[0].noUiSlider;d.set(c);var a=$("#playInterval").val()||2000;playTimer=setInterval(function(){if(c<2016){c++}else{if(c===2016){$("#play").removeClass("pause").addClass("play");clearInterval(playTimer)}else{c=1997}}d.set(c)},a)}function setMapColor(a){currentYear=a;$(".year").html(a);d3.selectAll(".area").attr("fill",function(h){for(var e=0;e<mapData.length;e++){var c=mapData[e];if(c["Local authority code"]===h.properties.lad16cd){var f=c["Q3-"+a];var g=parseInt(f.replace(/,/g,""),10);var b=colorCalculate(g);if(currentArea&&currentArea===h.properties.lad16cd){setSelectedInfo(c["Local authority name"],f)}return b}}return"#ffffff"})}function setSelectedInfo(b,a){$(".price").html(a);$(".local-authority").html(b)}function initSelectYear(){var b=1997;var a=2016;var c=$("#selectYear")[0];noUiSlider.create(c,{start:a,step:1,tooltips:true,range:{min:b,max:a},format:{to:function(d){return Math.round(d)},from:function(d){return Math.round(d)}}});c=c.noUiSlider;c.on("end",function(){var d=c.get();d=Math.round(d);c.set(d)});c.on("set",function(){var d=c.get();d=Math.round(d);setMapColor(d)});c.set(2016)}function colorCalculate(d){var e=0;for(var b=0,a=priceRange.length;b<a;b++){if(d<=priceRange[b]){e=b;break}}var c=d3.scaleLinear();c.domain([priceRange[e-1],priceRange[e]]).range([colorScheme[e-1],colorScheme[e]]);return c(d)}function initLine(){var a=document.getElementById("line").clientWidth;var l=document.getElementById("line").clientHeight;var c={top:50,right:80,bottom:30,left:50};var e=d3.select("#line").append("svg").attr("width",a).attr("height",l);a=a-c.left-c.right;l=l-c.top-c.bottom;var f=e.append("g").attr("width",a).attr("height",l).attr("transform","translate("+c.left+","+c.top+")");var k=d3.scaleTime().range([0,a]).domain([new Date(1997,0,1),new Date(2016,0,1)]).nice();var j=d3.scaleLinear().rangeRound([l,0]);var h=d3.scaleOrdinal(d3.schemeCategory10);var i=d3.scaleBand().range([0,a]).domain(d3.range(1996,2016));var d=d3.area().x(function(b){return k(b.date)}).y0(l).y1(function(b){return j(b.price)});f.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+l+")").call(d3.axisBottom(k).ticks(20).tickFormat(d3.timeFormat("%Y"))).append("text").attr("x",a+30).attr("y",5).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Year");f.append("g").attr("class","axis axis--y").append("text").attr("y",-10).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("£");initLineSelect(f,k,j,h,d);drawLine("England and Wales",f,k,j,h,d);initLineBar(f,h,i,l)}function drawLine(u,q,k,j,i,l){var a=500;var h=lineData1[u];var f=lineData2[u];var t=[h,f];var b=["Median house price","Median gross annual earning"];var m=d3.extent(h.concat(f),function(g){return g.price});console.log(m);j.domain([0,m[1]+100]).nice();d3.select(".axis.axis--y").transition().call(d3.axisLeft().scale(j));var c=q.selectAll(".line").data(t);c.exit().remove();var s=c.enter().append("path").attr("class","line").style("fill-opacity",0.3).attr("fill",function(v,g){return i(g)}).attr("stroke",function(v,g){return i(g)}).attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5);s.merge(c).transition().duration(a).attr("d",l);var e=q.selectAll(".tooltips1").data(h);e.exit().remove();var p=e.enter().append("circle").attr("class","tooltips tooltips1").attr("r",3).attr("stroke","#000").attr("stroke-opacity",0.3).attr("fill",i(0));p.merge(e).attr("area",function(g){return g.area}).attr("year",function(g){return g.year}).attr("price",function(g){return g.price}).transition().duration(a).attr("cx",function(g){return k(g.date)}).attr("cy",function(g){return j(g.price)});var d=q.selectAll(".tooltips2").data(f);d.exit().remove();var n=d.enter().append("circle").attr("class","tooltips tooltips2").attr("r",3).attr("stroke","#000").attr("stroke-opacity",0.3).attr("fill",i(1));n.merge(d).attr("area",function(g){return g.area}).attr("year",function(g){return g.year}).attr("price",function(g){return g.price}).transition().duration(a).attr("cx",function(g){return k(g.date)}).attr("cy",function(g){return j(g.price)});var r=q.selectAll(".line-label").data(b);r.exit().remove();r.enter().append("text").attr("class","line-label").attr("x",40).attr("y",function(v,g){return 24*g+6}).text(function(g){return g});var o=q.selectAll(".line-label-circle").data(b);o.exit().remove();o.enter().append("circle").attr("class","line-label-circle").attr("r",8).attr("cx",30).attr("cy",function(v,g){return 24*g}).attr("fill",function(v,g){return i(g)})}function initLineBar(f,i,c,a){var e=$(f.node());var h=lineData1["England and Wales"];var d=f.selectAll(".line-bar").data(h);d.exit().remove();d.enter().append("rect").attr("class","line-bar").attr("year",function(b){return b.date.getFullYear()}).attr("x",function(j,g){var b=c(j.date.getFullYear())-c.bandwidth()/2;if(!b){b=c(2015)+c.bandwidth()/2}return b}).attr("width",c.bandwidth()).attr("height",a).attr("y",0).attr("fill","black").attr("opacity",0).on("mouseover",function(m){var o=m.date.getFullYear();var n=e.find('.tooltips[year="'+o+'"]');n.attr("r",6);var j=e.find('.tooltips1[year="'+o+'"]').attr("area");var l=e.find('.tooltips1[year="'+o+'"]').attr("price");var g=e.find('.tooltips2[year="'+o+'"]').attr("price");var p=$('<div class="tooltip-layer"></div>');p.html("<b>Area:"+j+"</b><br><b>Year:"+o+'</b><ul><li>Median house price: £<b style="color:'+i(0)+'">'+csn(l)+'</b></li><li>Median gross annual earning: £<b style="color:'+i(1)+'">'+csn(g)+"</b></li></ul>");var k=$(n.get(0)).offset();var b=$(n.get(1)).offset();p.css({left:k.left+20+"px",top:(k.top+b.top)/2-30+"px"});$(document.body).append(p)}).on("mouseout",function(g){var b=g.date.getFullYear();e.find('.tooltips[year="'+b+'"]').attr("r",3);$(".tooltip-layer").remove()})}function initLineSelect(e,b,h,f,c){var a=$("#selectLineArea select");var d=_.keys(lineData1);_.each(d,function(i){var g=$('<option value="'+i+'">'+i+"</option>");a.append(g)});a.on("change",function(){var g=a.val();drawLine(g,e,b,h,f,c)})}function initBar(){var a=document.getElementById("bar").clientWidth;var l=document.getElementById("bar").clientHeight;var c={top:50,right:80,bottom:30,left:50};var d=d3.select("#bar").append("svg").attr("width",a).attr("height",l);a=a-c.left-c.right;l=l-c.top-c.bottom;var e=d.append("g").attr("width",a).attr("height",l).attr("transform","translate("+c.left+","+c.top+")");var k=d3.scaleTime().range([0,a]).domain([new Date(1997,0,1),new Date(2016,0,1)]).nice();var j=d3.scaleLinear().range([l,0]);var h=d3.scaleOrdinal(d3.schemeCategory10);var i=d3.scaleBand().range([0,a]).domain(d3.range(1996,2016));var m=d3.line().x(function(b){return k(b.date)}).y(function(b){return j(b.ratio)});e.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+l+")").call(d3.axisBottom(k).ticks(20).tickFormat(d3.timeFormat("%Y"))).append("text").attr("x",a+30).attr("y",5).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Year");e.append("g").attr("class","axis axis--y").append("text").attr("x",80).attr("y",-20).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Affordability ratio");var f=["England and Wales","London"];initSelectBarArea(f,e,k,j,h,m)}function drawBarLines(k,o,i,h,f,j){var a=500;var p=_.reduce(k,function(g,t){return g.concat(barData1[t])},[]);var e=_.map(k,function(g){return barData1[g]});var d=d3.max(p,function(g){return g.ratio});h.domain([0,d]);o.select(".axis--y").transition().call(d3.axisLeft().scale(h));var b=o.selectAll(".line").data(e);b.exit().remove();var r=b.enter().append("path").attr("class","line").attr("fill","none").style("stroke",function(t,g){return f(g)}).attr("stroke","steelblue").attr("stroke-linejoin","round").attr("stroke-linecap","round").attr("stroke-width",1.5);r.merge(b).transition().duration(a).attr("d",j);var q=o.selectAll(".bar-label").data(k);q.exit().remove();var s=q.enter().append("text").attr("class","bar-label").attr("font-size",12).attr("x",40);s.merge(q).transition().duration(a).attr("y",function(t,g){return 16*g+4}).text(function(g){return g});var m=o.selectAll(".bar-label-circle").data(k);m.exit().remove();var n=m.enter().append("circle").attr("class","bar-label-circle").attr("r",4).attr("cx",30);n.merge(m).transition().duration(a).attr("cy",function(t,g){return 16*g}).attr("fill",function(t,g){return f(g)});var c=o.selectAll(".tooltips").data(p);c.exit().remove();var l=c.enter().append("circle").attr("class","tooltips").attr("name",function(t,g){return k[Math.floor(g/20)]}).attr("year",function(g){return g.year}).attr("ratio",function(g){return g.ratio}).attr("r",2).attr("stroke","#000").attr("stroke-opacity",0.3).attr("fill",function(t,g){return f(Math.floor(g/20))}).style("cursor","pointer");l.merge(c).transition().duration(a).attr("cx",function(g){return i(g.date)}).attr("cy",function(g){return h(g.ratio)});o.selectAll(".tooltips").on("mouseover",function(z,t){var v=z.date.getFullYear();var w=z.area;var x=$(d3.select(this).node());x.attr("r",6);var u=z.ratio;var g=$('<div class="tooltip-layer"></div>');g.html("<b>Area:"+w+"</b><br><b>Year:"+v+'</b><ul><li>Ratio(Median house price to Median gross annual earning): <br><b style="color:'+f(Math.floor(t/20))+'">'+u+"</b></li></ul>");var y=x.offset();g.css({left:y.left+20+"px",top:y.top+20+"px"});$(document.body).append(g)}).on("mouseout",function(g){$(d3.select(this).node()).attr("r",2);$(".tooltip-layer").remove()}).on("click",function(g){$(d3.select(this).node()).attr("r",2);$(".tooltip-layer").remove();$("#bar").animate({width:"toggle"},"slow");$("#bar2").animate({width:"toggle"},"slow",function(){drawBarBar(g.area,g.date.getFullYear())});$("#barPanel").hide();$("#bar2Panel").show()})}function initSelectBarArea(e,c,h,f,d,k){e=e||[];var i=$("#selectBarArea");var a=_.keys(barData1);_.each(a,function(l){var g=$('<option value="'+l+'">'+l+"</option>");i.append(g)});var j=$("#barAreaList");_.each(e,function(l){var g=$("<li>"+l+'<i class="remove"></i></li>');j.append(g)});j.on("click","li i",function(){var g=$(this);var m=g.attr("area");var l=e.indexOf(m);e.splice(l,1);g.parent().remove();drawBarLines(e,c,h,f,d,k)});var b=$("#addBarArea");b.on("click",function(){var l=i.val();if(!_.contains(e,l)){e.push(l);var g=$("<li>"+l+'<i area="'+l+'" class="remove"></i></li>');j.append(g);drawBarLines(e,c,h,f,d,k)}});drawBarLines(e,c,h,f,d,k)}function initBarBar(){var d=document.getElementById("bar").clientWidth;var b=document.getElementById("bar").clientHeight;var f={top:50,right:80,bottom:30,left:150};var c=d3.select("#bar2").append("svg").attr("width",d).attr("height",b);d=d-f.left-f.right;b=b-f.top-f.bottom;var e=c.append("g").attr("width",d).attr("height",b).attr("transform","translate("+f.left+","+f.top+")");var a=d3.scaleLinear().range([0,d]);var i=d3.scaleBand().range([0,b]);var h=d3.scaleOrdinal(d3.schemeCategory10);e.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+b+")").append("text").attr("x",d+30).attr("y",5).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Ratio");e.append("g").attr("class","axis axis--y").append("text").attr("y",-10).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("District name");drawBarBar(e,a,i,h);$("#backToBar").on("click",function(){$("#bar").animate({width:"toggle"},"slow");$("#bar2").animate({width:"toggle"},"slow");$("#barPanel").show();$("#bar2Panel").hide()})}function drawBarBar(b,a,d,c){drawBarBar=function(e,m){var f=500;var g=barData2;if(e==="England"){g=_.filter(barData2,function(o){return o["Region name"]!=="Wales"})}else{if(e!=="England and Wales"){g=_.filter(barData2,function(o){return o["Region name"]===e})}}_.each(g,function(p){for(var o=1997;o<2017;o++){p[o]=parseFloat(p[o])||0}});g=_.filter(g,function(o){return o[m]!=0});g.sort(function(p,o){return o[m]-p[m]});if(g.length>6){g.splice(3,g.length-6)}console.log(g);var i=d3.max(g,function(o){return o[m]});console.log(i);a.domain([0,i]).nice();d.domain(_.pluck(g,"Name"));b.select(".axis--x").transition().call(d3.axisBottom().scale(a));b.select(".axis--y").transition().call(d3.axisLeft().scale(d));var n=b.selectAll(".bar").data(g);n.exit().remove();var h=n.enter().append("rect").attr("class","bar");h.merge(n).transition().duration(f).attr("x",0).attr("y",function(o){return d(o.Name)+d.bandwidth()/4}).attr("width",function(o){return a(o[m])}).attr("height",d.bandwidth()/2).attr("fill",function(p,o){return c(Math.floor(o/3))});var j=b.selectAll(".label").data(g);j.exit().remove();var l=j.enter().append("text").attr("class","label").attr("font-size",12);l.merge(j).transition().duration(f).attr("x",function(o){return a(o[m])+5}).attr("y",function(o){return d(o.Name)+d.bandwidth()/2}).text(function(o){return o[m]||"No data"});$("#bar2Area").html(e);$("#bar2Year").html(m);var k=_.reduce(g,function(p,o){return p+"<li>"+o.Name+": "+o[m]+"</li>"},"");$("#bar2List").html(k)}}function initDots(){var c=document.getElementById("dots").clientWidth;var o=document.getElementById("dots").clientHeight;var e={top:50,right:100,bottom:30,left:100};var f=d3.select("#dots").append("svg").attr("width",c).attr("height",o);c=c-e.left-e.right;o=o-e.top-e.bottom;var i=f.append("g").attr("width",c).attr("height",o).attr("transform","translate("+e.left+","+e.top+")");dotsData=_.filter(dotsData,function(g){return g["Region name"]==="England"||g["Region name"]==="Wales"});var d=d3.extent(dotsData,function(g){return parseFloat(g["Unemployment rate"])});var j=d3.extent(dotsData,function(g){return parseFloat(g["Change in house price"])});console.log(d,j);var n=d3.scaleLinear().range([0,c]).domain(d);var m=d3.scaleLinear().range([o,0]).domain(j);var l=d3.scaleOrdinal(dotsColor);i.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+m(0)+")").call(d3.axisBottom().scale(n)).append("text").attr("width",100).attr("x",c-30).attr("y",30).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Unemployment rate");i.append("g").attr("class","axis axis--y").call(d3.axisLeft().scale(m)).append("text").attr("width",100).attr("x",120).attr("y",-15).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Annual change in house price");var k=i.selectAll(".dot").data(dotsData);k.enter().append("circle").attr("class","dot").attr("r",5).attr("cx",function(g){return n(parseFloat(g["Unemployment rate"]))}).attr("cy",function(g){return m(parseFloat(g["Change in house price"]))}).attr("stroke","#000").attr("fill",function(p,g){return l(Math.floor(g/19))});var b=_.groupBy(dotsData,function(g){return g["Region name"]});b=_.keys(b);var a=i.selectAll(".label-circle").data(b);a.enter().append("circle").attr("class","label-circle").attr("r",5).attr("cx",c-80).attr("cy",function(p,g){return 15*g+10}).attr("stroke","#000").attr("fill",function(p,g){return l(g)});var h=i.selectAll(".label").data(b);h.enter().append("text").attr("class","label").attr("x",c-80+15).attr("y",function(p,g){return 15*g+13}).attr("stroke",function(p,g){return l(g)}).attr("font-size",12).text(function(g){return g})}function initDotsLine(){var e=document.getElementById("dotsLine").clientWidth;var n=document.getElementById("dotsLine").clientHeight;var f={top:50,right:150,bottom:30,left:50};var h=d3.select("#dotsLine").append("svg").attr("width",e).attr("height",n);e=e-f.left-f.right;n=n-f.top-f.bottom;var j=h.append("g").attr("width",e).attr("height",n).attr("transform","translate("+f.left+","+f.top+")");var d=[];_.each(_.keys(erData),function(r){var s=erData[r];for(var q=0,g=s.length;q<g;q++){d.push(parseFloat(s[q].rate))}});var m=d3.scaleTime().range([0,e]).domain([new Date(1997,0,1),new Date(2016,0,1)]).nice();var l=d3.scaleLinear().range([n,0]).domain([_.min(d),_.max(d)]);var k=d3.scaleOrdinal(dotsColor);var p=d3.line().x(function(g){return m(g.date)}).y(function(g){return l(g.rate)});j.append("g").attr("class","axis axis--x").attr("transform","translate(0,"+n+")").call(d3.axisBottom(m).ticks(20).tickFormat(d3.timeFormat("%Y"))).append("text").attr("width",100).attr("x",e+30).attr("y",0).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Year");j.append("g").attr("class","axis axis--y").call(d3.axisLeft().scale(l)).append("text").attr("width",100).attr("x",120).attr("y",-15).attr("fill","#000").attr("font-size",14).attr("font-weight","bold").text("Unemployment rate(%)");var c=[];_.each(_.keys(erData),function(g){c.push(erData[g])});var o=j.selectAll(".line").data(c);o.enter().append("path").attr("class","line").attr("fill","none").attr("stroke",function(q,g){return k(g)}).style("stroke-width",1.5).attr("d",p);var b=_.keys(erData);var a=j.selectAll(".label-circle").data(b);a.enter().append("circle").attr("class","label-circle").attr("r",5).attr("cx",e-30).attr("cy",function(q,g){return 15*g-15}).attr("stroke","#000").attr("fill",function(q,g){return k(g)});var i=j.selectAll(".label").data(b);i.enter().append("text").attr("class","label").attr("x",e-30+15).attr("y",function(q,g){return 15*g-12}).attr("stroke",function(q,g){return k(g)}).attr("font-size",12).text(function(g){return g})}function showLoading(){$("#loading").show()}function hideLoading(){$("#loading").hide()}function csn(a){while(/(\d+)(\d{3})/.test(a.toString())){a=a.toString().replace(/(\d+)(\d{3})/,"$1,$2")}return a};